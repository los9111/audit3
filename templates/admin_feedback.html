{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

  <h2><i class="fas fa-comments"></i> Feedback for “{{ project.project_name }}”</h2>
  <a href="{{ url_for('admin_portal') }}" class="btn btn-sm btn-outline-primary mb-3">
    <i class="fas fa-arrow-left"></i> Back to Admin
  </a>

  {# Tabs for Approved vs Pending #}
  {% set show_pending = request.args.get('filter') == 'pending' %}
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link {% if not show_pending %}active{% endif %}"
         href="{{ url_for('feedback_panel', project_id=project.id) }}">
        Approved
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if show_pending %}active{% endif %}"
         href="{{ url_for('feedback_panel', project_id=project.id, filter='pending') }}">
        Pending
      </a>
    </li>
  </ul>

  {% set comments = project.ratings | selectattr('comment') %}
  {% if show_pending %}
    {% set comments = comments | selectattr('approved', 'equalto', False) | list %}
  {% else %}
    {% set comments = comments | selectattr('approved', 'equalto', True) | list %}
  {% endif %}

  {% if comments %}
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Rating</th>
            <th>Comment</th>
            <th>Submitted At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in comments %}
          <tr>
            <td>{{ r.id }}</td>
            <td>
              {% if r.rating %}
                {{ r.rating }}/5
              {% else %}
                <em>—</em>
              {% endif %}
            </td>
            <td>{{ r.comment }}</td>
            <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
              {% if show_pending %}
                {# Approve button #}
                <button class="btn btn-sm btn-success approve-feedback me-1"
                        data-id="{{ r.id }}">
                  <i class="fas fa-check"></i>
                </button>
              {% endif %}
              {# Always allow delete #}
              <button class="btn btn-sm btn-danger delete-feedback"
                      data-id="{{ r.id }}">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">
      {% if show_pending %}No pending comments.{% else %}No approved comments.{% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const token = localStorage.getItem('jwtToken');
  const csrf  = document.querySelector('meta[name="csrf-token"]').content;

  // Approve
  document.querySelectorAll('.approve-feedback').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('Approve this comment?')) return;
      const id = btn.dataset.id;
      const res = await fetch(`/admin/feedback/${id}/approve`, {
        method:'POST',
        credentials:'include',
        headers:{
          'Authorization':`Bearer ${token}`,
          'X-CSRF-TOKEN':csrf
        }
      });
      if(res.ok) btn.closest('tr').remove();
      else alert('Failed to approve');
    });
  });

  // Delete
  document.querySelectorAll('.delete-feedback').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('Delete this comment?')) return;
      const id = btn.dataset.id;
      const res = await fetch(`/admin/feedback/${id}`, {
        method:'DELETE',
        credentials:'include',
        headers:{
          'Authorization':`Bearer ${token}`,
          'X-CSRF-TOKEN':csrf
        }
      });
      if(res.ok) btn.closest('tr').remove();
      else alert('Failed to delete');
    });
  });
});
</script>
{% endblock %}
