{% extends "base.html" %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ratingContainer = document.querySelector('.star-rating');
        let isProcessing = false;
        const projectId = {{ project.id }};
        const currentAvg = {{ project.average_rating() }};
        const hasRated = {% if session.get('rated_' ~ project.id) %}true{% else %}false{% endif %};

        // Initialize rating state
        if (hasRated) {
            document.querySelectorAll('.fa-star').forEach(star => {
                star.style.cursor = 'not-allowed';
            });
        }

        ratingContainer.addEventListener('click', async (e) => {
            if (isProcessing || hasRated) return;
            const star = e.target.closest('.fa-star');
            if (!star) return;

            isProcessing = true;
            const rating = parseInt(star.dataset.value);
            
            // Optimistic UI update
            const stars = document.querySelectorAll('.fa-star');
            stars.forEach((s, idx) => {
                s.style.color = idx < rating ? '#ffd700' : '#e4e5e9';
                s.classList.add('processing');
            });

            try {
                const response = await fetch(`/rate/${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': "{{ csrf_token() }}"
                    },
                    body: JSON.stringify({ rating: rating })
                });

                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to submit rating');
                }
                
                // Update UI state
                document.querySelector('.rating-count').textContent = 
                    `(${result.total_ratings} ratings)`;
                
                stars.forEach(star => {
                    star.style.cursor = 'not-allowed';
                });

                // Update average display
                stars.forEach((s, idx) => {
                    s.style.color = idx < result.new_average ? '#ffd700' : '#e4e5e9';
                });

            } catch (error) {
                console.error('Error:', error);
                // Revert to original state
                stars.forEach((s, idx) => {
                    s.style.color = idx < currentAvg ? '#ffd700' : '#e4e5e9';
                });
                alert(error.message);
            } finally {
                stars.forEach(star => star.classList.remove('processing'));
                isProcessing = false;
            }
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container">
  <!-- Data Protection Header -->
  <div class="data-protection-alert mb-4">
    <div class="alert {% if project.data_classification == 'RESTRICTED' %}alert-warning{% else %}alert-info{% endif %}">
      <div class="d-flex align-items-center">
        <i class="fas fa-database me-3 fs-4"></i>
        <div>
          <h5 class="mb-1">Data Classification: {{ project.data_classification|upper }}</h5>
          {% if project.data_protection_compliant %}
            <span class="badge bg-success">
              <i class="fas fa-check-circle me-1"></i> NHS Compliance Verified
            </span>
          {% else %}
            <span class="badge bg-danger">
              <i class="fas fa-exclamation-circle me-1"></i> Compliance Not Verified
            </span>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="nhs-data-alert alert alert-secondary">
      <i class="fas fa-exclamation-triangle me-2"></i>
      This audit contains NHS data - Handle in accordance with 
      <a href="{{ url_for('data_protection_policy') }}" class="alert-link">IG Policy v3.2</a>
    </div>
  </div>

  <div class="card project-card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <h1 class="card-title">{{ project.project_name }}</h1>
        <div class="rating-section">
          <div class="star-rating">
            {% for i in range(1,6) %}
              <i class="fas fa-star star-rating"
                 data-value="{{ i }}"
                 style="color: {% if i <= project.average_rating() %}#ffd700{% else %}#e4e5e9{% endif %}; 
                        cursor: {% if session.get('rated_' ~ project.id) %}not-allowed{% else %}pointer{% endif %};">
              </i>
            {% endfor %}
          </div>
          <small class="text-muted rating-count">({{ project.ratings|length }} ratings)</small>
        </div>
      </div>

      <!-- COMMENT FORM -->
      <form id="commentForm" class="mb-4">
        <div class="mb-3">
          <label for="comment" class="form-label">Leave a comment</label>
          <textarea id="comment" name="comment" class="form-control"
                    rows="3" minlength="10" maxlength="500" required></textarea>
        </div>
        <button class="btn btn-primary">Submit Comment</button>
      </form>
      <script>
        document.getElementById('commentForm').addEventListener('submit', async e => {
          e.preventDefault();
          const comment = e.target.comment.value.trim();
          if (comment.length < 10) return alert('Comment too short');
          
          try {
            const res = await fetch(`/comment/{{ project.id }}`, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({comment})
            });
            
            if (!res.ok) {
              const error = await res.json();
              throw new Error(error.message || 'Error submitting comment');
            }
            
            alert('Thanks! Your comment is awaiting approval.');
            e.target.reset();
          } catch (error) {
            alert(error.message);
          }
        });
      </script>

      <!-- APPROVED COMMENTS DISPLAY -->
      <h5 class="mt-4">Comments</h5>
      {% for r in project.ratings if r.comment and r.approved %}
        <div class="mb-3 border-bottom pb-2">
          <small class="text-muted">{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
          <p class="mt-1">{{ r.comment }}</p>
        </div>
      {% else %}
        <p class="text-muted">No comments yet.</p>
      {% endfor %}

      <!-- Project Metadata -->
      <div class="project-meta mb-4">
        <div class="row">
          <div class="col-md-4">
            <p><i class="fas fa-hospital me-2"></i>{{ get_trust_name(project.hospital) }}</p>
            <p><i class="fas fa-calendar-alt me-2"></i>{{ project.year }}</p>
            <p><i class="fas fa-tag me-2"></i>{{ project.project_type|upper }}</p>
          </div>
          <div class="col-md-4">
            <p><i class="fas fa-stethoscope me-2"></i>{{ project.specialty }}</p>
            <p><i class="fas fa-clock me-2"></i>{{ project.date_added.strftime('%d %b %Y') }}</p>
          </div>
        </div>
      </div>

      <!-- Project Details -->
      <div class="project-details mb-4">
        <h4>Guidelines Used</h4>
        <div class="preserve-formatting mb-3">{{ project.guidelines or 'Not specified' }}</div>

        <h4>Background</h4>
        <div class="preserve-formatting mb-3">{{ project.background }}</div>

        <h4>Aims</h4>
        <div class="preserve-formatting mb-3">{{ project.aims }}</div>

        <h4>Objectives</h4>
        <div class="preserve-formatting mb-3">{{ project.objectives }}</div>

        <div class="keywords">
          {% for keyword in project.keywords.split(',') %}
            <span class="badge bg-secondary me-1">{{ keyword.strip() }}</span>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>

  <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
    <i class="fas fa-arrow-left me-2"></i> Back to Home
  </a>
</div>
{% endblock %}